<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <title>Pi Pyramid — Free Mint | Inpinity.online</title>

  <meta name="description" content="Offizieller Free Mint der Pi Pyramid. 10.000 NFTs (#0–#9999). Royalties 7 %, Creator 100 %." />
  <meta property="og:title" content="Pi Pyramid — Free Mint | Inpinity.online" />
  <meta property="og:description" content="Kostenloser Mint für 10.000 NFTs (#0–#9999)." />
  <meta property="og:image" content="https://ipfs.inpinity.online/ipfs/bafybeicbxxwossaiogadmonclbijyvuhvtybp7lr5ltnotnqqezamubcr4/0.png" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />

  <style>
    :root {
      --bg: #0a0b10;
      --panel: #0f1017;
      --panel2: #161727;
      --line: #21233a;
      --text: #e7e8ff;
      --muted: #9aa3c7;
      --accent: #8b5cf6;
      --accent2: #22d3ee;
      --ok: #10b981;
      --err: #ef4444;
      --w: 980px;
      --r: 14px;
    }
    
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif,system-ui,Inter,Arial,sans-serif;
      background:
        radial-gradient(1000px 600px at 90% -10%, rgba(139,92,246,.16), transparent 60%),
        radial-gradient(1000px 600px at -10% 120%, rgba(34,211,238,.16), transparent 60%),
        var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    a { color: var(--accent2); text-decoration: none; }
    a:hover { text-decoration: underline; }
    
    /* Topbar */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: var(--w);
      margin: 20px auto 10px;
      padding: 8px 16px;
    }
    .brand { display: flex; gap: 12px; align-items: center; }
    .logo {
      width: 44px; height: 44px; border-radius: 12px; display: grid; place-items: center;
      background: linear-gradient(135deg, rgba(139,92,246,.45), rgba(34,211,238,.45));
      border: 1px solid var(--line); font-weight: 800; font-size: 22px;
    }
    h1 { font-size: 20px; margin: 0; }
    .sub { margin: 2px 0 0; color: var(--muted); font-size: 13px; }
    
    /* Layout */
    .container { max-width: var(--w); margin: 0 auto 30px; padding: 0 16px; }
    .card {
      background: linear-gradient(0deg, rgba(255,255,255,.02), rgba(255,255,255,.02)), var(--panel);
      border: 1px solid var(--line); border-radius: var(--r); padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .grid { display: grid; gap: 16px; margin: 16px 0; grid-template-columns: 1fr 1fr; }
    @media(max-width:860px){ .grid{ grid-template-columns: 1fr; } }
    
    /* Statusbar */
    .statusbar { margin-top: 8px; display: flex; gap: 18px; flex-wrap: wrap; font-size: .95rem; }
    .muted { color: var(--muted); }
    .hint { color: var(--muted); font-size: .92rem; }
    .status { margin: .8rem 0 0; padding: 8px 10px; border-radius: 10px; border: 1px solid transparent; text-align: center; }
    .status.ok   { color: var(--ok);  border-color: rgba(16,185,129,.25); background: rgba(16,185,129,.08); }
    .status.err  { color: var(--err); border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.08); }
    .status.warn { color: #f59e0b;    border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.08); }
    .status.info { color: #38bdf8;    border-color: rgba(56,189,248,.25); background: rgba(56,189,248,.08); }
    
    /* Forms & Buttons */
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .lbl { display: block; margin: 6px 0; color: var(--muted); }
    .inpt {
      background: #0c0d14; color: var(--text); border: 1px solid var(--line);
      border-radius: 10px; padding: 10px 12px; width: 100%;
    }
    .inpt:focus { outline: 2px solid rgba(139,92,246,.4); }
    .inpt-num { width: 160px; }
    
    .btn {
      background: #0c0d14; color: var(--text); border: 1px solid var(--line);
      border-radius: 10px; padding: 10px 14px; cursor: pointer; display: inline-flex;
      align-items: center; gap: 10px; transition: border-color .15s ease;
      font-size: 14px;
    }
    .btn:hover { border-color: var(--accent2); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent2)); border-color: transparent; color: #081018; font-weight: 700; }
    .btn-ghost { background: transparent; }
    
    /* Wallet Dropdown */
    .wallet-connect { position: relative; }
    
    /* Preview */
    .preview .mediaBox {
      margin: .5rem 0; display: grid; place-items: center; min-height: 220px;
      border: 1px dashed var(--line); border-radius: 10px; padding: 10px;
      overflow: hidden;
    }
    .preview .mediaBox img,
    .preview .mediaBox video { 
      max-width: 100%; 
      max-height: 300px; 
      border-radius: 8px; 
      object-fit: contain;
    }
    .preview .metaBox { font-size: .95rem; color: var(--muted); }
    .preview .metaBox dl{ display: grid; grid-template-columns: max-content 1fr; gap: .35rem 1rem; }
    .preview .metaBox dt{ color: var(--text); font-weight: 600; }
    .preview .metaBox dd{ margin: 0 0 .4rem 0; }
    
    /* Logs */
    .logs-card { margin-top: 20px; }
    .logs-header { display: flex; justify-content: space-between; align-items: center; }
    #toggleLogs { padding: 6px 10px; font-size: .9rem; }
    .log {
      background: #090a0f; border: 1px solid var(--line); border-radius: 10px;
      color: #c5cffd; padding: 10px; height: 200px; overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12.5px;
      white-space: pre-wrap;
    }
    .hidden { display: none; }
    
    /* Spinner */
    .spinner {
      width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.35);
      border-top-color: #fff; border-radius: 50%; animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Footer */
    .foot {
      max-width: var(--w); margin: 10px auto 30px; display: flex; justify-content: space-between;
      color: var(--muted); padding: 0 16px; font-size: 14px;
    }
    
    /* Fatal banner */
    #fatal {
      display: none; position: sticky; top: 0; left: 0; right: 0;
      background: #3b0b0b; color: #ffdede; padding: 12px; 
      border-bottom: 1px solid #6a1a1a; z-index: 9999;
      text-align: center; font-weight: 500;
    }
    
    .btn-label { transition: opacity 0.2s; }

    /* Donation Pills */
    .donos { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .pill {
      border: 1px solid var(--line); border-radius: 999px; padding: 8px 12px; cursor: pointer; background: #0c0d14;
      font-size: 14px;
    }
    .pill input { display: none; }
    .pill.active { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(139,92,246,.25) inset; }
    .custom { display: none; width: 160px; margin-top: 8px; }
    .custom.visible { display: block; }
    
    .low-balance { color: #f59e0b !important; font-weight: 600; }
  </style>
</head>
<body>
  <div id="fatal"></div>

  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">π</div>
      <div>
        <h1>Pi Pyramid</h1>
        <p class="sub">Offizieller Free Mint · Inpinity.online</p>
      </div>
    </div>
    <div class="wallet-connect">
      <button id="connectBtn" class="btn btn-ghost">Mit Phantom verbinden</button>
    </div>
  </header>

  <main class="container">
    <section class="card intro">
      <p>Insgesamt <b>10.000</b> NFTs (#0–#9999). Kostenloser Mint. On-chain Royalties: <b>7&nbsp;%</b> · Creator: <b>100&nbsp;%</b>.</p>
      <div class="statusbar">
        <div><span class="muted">Wallet:</span> <span id="walletLabel" class="muted">nicht verbunden</span></div>
        <div><span class="muted">Balance:</span> <span id="balanceLabel" class="muted">–</span></div>
        <div><span class="muted">Geschätzte Kosten:</span> <span id="costLabel" class="muted">≈ 0.003 SOL</span></div>
      </div>
    </section>

    <section class="grid">
      <div class="card">
        <h3>NFT Auswahl</h3>
        <label class="lbl">Token-Nummer (0–9999)</label>
        <div class="row">
          <input id="tokenId" type="number" min="0" max="9999" value="0" class="inpt inpt-num" />
          <button id="randBtn" class="btn">Zufällige freie ID</button>
        </div>
        <p class="muted">frei: <span id="freeCounter">–</span></p>
        <p class="muted">Metadata-URI: <span id="previewUri">–</span></p>
        <p id="uriStatus" class="muted"></p>
      </div>

      <div class="card">
        <h3>Optionale Spende an Creator</h3>
        <div id="donationOptions" class="donos" role="radiogroup">
          <label class="pill active"><input type="radio" name="donation" value="0" checked /> Keine Spende</label>
          <label class="pill"><input type="radio" name="donation" value="0.01" /> 0.01 SOL</label>
          <label class="pill"><input type="radio" name="donation" value="0.1" /> 0.1 SOL</label>
          <label class="pill"><input type="radio" name="donation" value="1" /> 1 SOL</label>
          <label class="pill"><input type="radio" name="donation" value="custom" /> Eigener Betrag</label>
        </div>
        <div id="customDonationContainer" class="custom">
          <input type="number" id="customDonationInput" min="0" step="0.01" placeholder="SOL Betrag" class="inpt" />
        </div>
        <p class="muted">Deine Spende unterstützt den Creator direkt.</p>
      </div>
    </section>

    <section class="card preview">
      <h3>Vorschau</h3>
      <div id="mediaBox" class="mediaBox muted">Keine Vorschau geladen.</div>
      <div id="metaBox" class="metaBox"></div>
    </section>

    <section class="card action">
      <button id="mintBtn" class="btn btn-primary" disabled>
        <span class="btn-label">Jetzt kostenlos minten</span>
        <span class="spinner" hidden></span>
      </button>
      <p id="status" class="status"></p>
      <p class="hint">Nach Klick wirst du im Wallet zum Signieren aufgefordert.</p>
    </section>

    <section class="card logs-card">
      <div class="logs-header">
        <h3>Logs</h3>
        <button id="toggleLogs" class="btn btn-ghost">Anzeigen</button>
      </div>
      <pre id="log" class="log hidden"></pre>
    </section>
  </main>

  <footer class="foot">
    <span>© Inpinity.online</span>
    <a href="https://solscan.io/address/DmKi8MtrpfQXVQvNjUfxWgBC3xFL2Qn5mvLDMgMZrNmS" target="_blank" rel="noopener">Collection auf Solscan</a>
  </footer>

  <script type="module">
    /* ========= KONFIG ========= */
    const CFG = {
      RPCs: [
        "https://api.mainnet-beta.solana.com"
      ],
      currentRPC: 0,

      CREATOR: "GEFoNLncuhh4nH99GKvVEUxe59SGe74dbLG7UUtfHrCp",
      COLLECTION_MINT: "DmKi8MtrpfQXVQvNjUfxWgBC3xFL2Qn5mvLDMgMZrNmS",

      ROYALTY_BPS: 700,
      MAX_INDEX: 9999,

      JSON_BASE_CID: "bafybeibjqtwncnrsv4vtcnrqcck3bgecu3pfip7mwu4pcdenre5b7am7tu",
      MP4_BASE_CID: "bafybeic6dwzp2lk3xf7wylsxo5kqqmvcgqlf6pp4v4ov3e2x6evrjipbam",
      PNG_BASE_CID: "bafybeicbxxwossaiogadmonclbijyvuhvtybp7lr5ltnotnqqezamubcr4",

      GATEWAYS: [
        "https://ipfs.inpinity.online/ipfs",
        "https://ipfs.io/ipfs",
        "https://cloudflare-ipfs.com/ipfs"
      ],

      BASE_ESTIMATED_COST: 0.003,
      TOKEN_STANDARD: 4
    };

    /* ========= IMPORTS ========= */
    import { createUmi } from "https://esm.sh/@metaplex-foundation/umi-bundle-defaults@1.2.0?bundle";
    import { publicKey as umiPk, generateSigner, transactionBuilder, lamports, base58, some } from "https://esm.sh/@metaplex-foundation/umi@1.2.0?bundle";
    import { walletAdapterIdentity } from "https://esm.sh/@metaplex-foundation/umi-signer-wallet-adapters@1.2.0?bundle";
    import {
      mplTokenMetadata,
      createV1,
      mintV1,
      findMasterEditionPda
    } from "https://esm.sh/@metaplex-foundation/mpl-token-metadata@3.4.0?bundle";
    import {
      setComputeUnitLimit,
      setComputeUnitPrice,
      transferSol,
      findAssociatedTokenPda
    } from "https://esm.sh/@metaplex-foundation/mpl-toolbox@0.10.0?bundle";

    /* ========= HELPER ========= */
    const $ = (id) => document.getElementById(id);
    const setStatus = (t, cls = "") => { 
      const el = $("status"); 
      if (!el) return; 
      el.className = `status ${cls}`; 
      el.innerHTML = t; 
    };
    
    const log = (msg, obj) => {
      const el = $("log");
      if (!el) return;
      const time = new Date().toLocaleTimeString();
      const line = `[${time}] ${msg}`;
      el.textContent += line + (obj ? " " + JSON.stringify(obj, null, 2) : "") + "\n";
      el.scrollTop = el.scrollHeight;
      if (/error|warn|fehler|❌|⚠️/i.test(msg)) {
        el.classList.remove("hidden");
        const t = $("toggleLogs"); 
        if (t) t.textContent = "Ausblenden";
      }
    };
    
    const setSpin = (on) => {
      const sp = document.querySelector(".spinner");
      const lbl = document.querySelector(".btn-label");
      if (!sp || !lbl) return;
      sp.hidden = !on;
      lbl.style.opacity = on ? 0.75 : 1;
    };

    const uriForId = (id) => `ipfs://${CFG.JSON_BASE_CID}/${id}.json`;
    const httpForId = (id, gw = 0) => `${CFG.GATEWAYS[gw]}/${CFG.JSON_BASE_CID}/${id}.json`;
    
    const toHttp = (url) => {
      if (!url) return url;
      if (url.startsWith("ipfs://")) {
        return `${CFG.GATEWAYS[0]}/${url.replace("ipfs://", "").replace(/^ipfs\//, "")}`;
      }
      return url;
    };

    /* ========= PHANTOM WALLET ========= */
    let umi = null;
    let phantom = null;
    let originalText = "";

    function setRpc(index) {
      CFG.currentRPC = index % CFG.RPCs.length;
      if (phantom) {
        umi = createUmi(CFG.RPCs[CFG.currentRPC])
          .use(walletAdapterIdentity(phantom))
          .use(mplTokenMetadata());
      }
      log("RPC gewechselt", { rpc: CFG.RPCs[CFG.currentRPC] });
    }

    async function connectPhantom() {
      try {
        // Phantom Wallet erkennen
        if (!window.solana?.isPhantom) {
          throw new Error("Phantom Wallet nicht gefunden. Bitte installiere die Phantom Wallet Extension.");
        }
        phantom = window.solana;

        // Verbindung herstellen
        const resp = await phantom.connect();
        const pk58 = resp.publicKey.toString();
        
        // UI aktualisieren
        $("walletLabel").textContent = `${pk58.slice(0, 4)}…${pk58.slice(-4)}`;
        $("connectBtn").textContent = "Phantom verbunden";
        setStatus("Wallet verbunden. Bereit zum Minten.", "ok");
        log("Phantom Wallet verbunden", { address: pk58 });

        // UMI mit Phantom initialisieren
        setRpc(0);
        await updateBalance();
        $("mintBtn").disabled = false;

        // Disconnect-Handler
        phantom.on("disconnect", () => {
          log("Wallet getrennt");
          $("walletLabel").textContent = "nicht verbunden";
          $("connectBtn").textContent = "Mit Phantom verbinden";
          $("mintBtn").disabled = true;
          setStatus("Wallet getrennt. Bitte erneut verbinden.", "warn");
          umi = null;
        });
      } catch (e) {
        handleError("Phantom Verbindung fehlgeschlagen:", e);
      }
    }

    /* ========= CLAIMS ========= */
    let claimedSet = new Set();
    let availableIds = [];
    
    function recomputeAvailable() {
      availableIds = [];
      for (let i = 0; i <= CFG.MAX_INDEX; i++) {
        if (!claimedSet.has(i)) availableIds.push(i);
      }
      const el = $("freeCounter");
      if (el) el.textContent = `${availableIds.length} / ${CFG.MAX_INDEX + 1}`;
    }
    
    async function isIdAvailable(id) {
      if (claimedSet.has(id)) return false;
      try {
        const res = await fetch(`${CFG.GATEWAYS[0]}/${CFG.JSON_BASE_CID}/${id}.json`, {
          method: "HEAD",
          cache: "no-store"
        });
        return res.ok;
      } catch {
        return false;
      }
    }
    
    async function pickRandomFreeId() {
      if (availableIds.length === 0) return 0;
      
      // Effiziente Suche mit limitierten Versuchen
      const attempts = Math.min(30, availableIds.length);
      const shuffled = [...availableIds].sort(() => Math.random() - 0.5);
      
      for (let i = 0; i < attempts; i++) {
        const id = shuffled[i];
        if (await isIdAvailable(id)) return id;
      }
      
      // Fallback auf erste verfügbare ID
      return shuffled[0] || 0;
    }
    
    async function setRandomFreeId() {
      const inp = $("tokenId");
      if (!inp) return;
      
      setStatus("Suche freie ID...", "info");
      const id = await pickRandomFreeId();
      inp.value = String(id);
      await updatePreview();
    }

    /* ========= PREVIEW ========= */
    const previewCache = {};
    
    async function updatePreview() {
      const id = Number($("tokenId").value || 0);
      $("previewUri").textContent = uriForId(id);
      $("uriStatus").textContent = "prüfe URI …";

      const media = $("mediaBox");
      const metaBox = $("metaBox");
      media.innerHTML = '<div class="muted">Lade Vorschau...</div>';
      metaBox.innerHTML = "";

      if (previewCache[id]) {
        renderPreview(id, previewCache[id]);
        return;
      }

      let meta = null;
      let success = false;
      
      // Eigenes Gateway zuerst versuchen
      try {
        const res = await fetch(`${CFG.GATEWAYS[0]}/${CFG.JSON_BASE_CID}/${id}.json`, { 
          cache: "no-store" 
        });
        if (res.ok) {
          meta = await res.json();
          success = true;
        }
      } catch (e) {
        log(`Eigenes Gateway fehlgeschlagen: ${e.message}`);
      }
      
      // Fallback zu anderen Gateways
      if (!success) {
        for (let i = 1; i < CFG.GATEWAYS.length; i++) {
          try {
            const res = await fetch(httpForId(id, i), { cache: "no-store" });
            if (!res.ok) continue;
            meta = await res.json();
            success = true;
            break;
          } catch (e) {
            log(`Gateway ${CFG.GATEWAYS[i]} fehlgeschlagen: ${e.message}`);
          }
        }
      }

      // Fallback für Medien
      if (meta) {
        if (!meta.image) meta.image = `ipfs://${CFG.PNG_BASE_CID}/${id}.png`;
        if (!meta.animation_url) meta.animation_url = `ipfs://${CFG.MP4_BASE_CID}/${id}.mp4`;
      }

      if (!success || !meta) {
        $("uriStatus").textContent = "⚠️ Metadaten nicht gefunden";
        media.innerHTML = '<div class="muted">Vorschau nicht verfügbar</div>';
        return;
      }

      previewCache[id] = meta;
      renderPreview(id, meta);
    }

    function renderPreview(id, meta) {
      $("uriStatus").textContent = "✅ Metadaten geladen";

      // Validierung
      const errs = [];
      if (!meta.name) errs.push("Name fehlt");
      if (!meta.image && !meta.animation_url) errs.push("Medien fehlen");
      if (meta.seller_fee_basis_points !== undefined && meta.seller_fee_basis_points !== CFG.ROYALTY_BPS) {
        errs.push(`Royalties nicht ${CFG.ROYALTY_BPS / 100}%`);
      }
      if (errs.length) $("uriStatus").textContent += ` ⚠️ ${errs.join(", ")}`;

      // Medienanzeige
      const media = $("mediaBox");
      let mediaHtml = "";
      
      if (meta.animation_url) {
        const mediaUrl = toHttp(meta.animation_url);
        mediaHtml = `<video src="${mediaUrl}" controls autoplay loop muted playsinline></video>`;
      } else if (meta.image) {
        const imageUrl = toHttp(meta.image);
        mediaHtml = `<img src="${imageUrl}" alt="Preview ${id}" />`;
      } else {
        mediaHtml = '<div class="muted">Keine Medien verfügbar</div>';
      }
      
      media.innerHTML = mediaHtml;

      // Metadaten
      const metaBox = $("metaBox");
      const dl = document.createElement("dl");
      
      const add = (k, v) => {
        const dt = document.createElement("dt");
        dt.textContent = k; 
        const dd = document.createElement("dd");
        dd.textContent = v; 
        dl.append(dt, dd);
      };
      
      add("Name", meta.name || `Pi Pyramid #${id}`);
      if (meta.description) add("Beschreibung", meta.description);
      
      if (Array.isArray(meta.attributes)) {
        add("Attribute", meta.attributes.map(a => 
          `${a.trait_type || 'Trait'}: ${a.value}`
        ).join(" · "));
      }
      
      metaBox.innerHTML = "";
      metaBox.appendChild(dl);
    }

    /* ========= MINT ========= */
    async function doMint() {
      const mintBtn = $("mintBtn");
      if (!mintBtn) return;
      
      try {
        mintBtn.disabled = true;
        const btnLabel = mintBtn.querySelector(".btn-label");
        originalText = btnLabel.textContent;
        btnLabel.textContent = "Verarbeite...";
        setSpin(true);

        if (!umi || !phantom) throw new Error("Wallet nicht verbunden");
        const id = Number($("tokenId").value || 0);
        
        if (!Number.isInteger(id) || id < 0 || id > CFG.MAX_INDEX) {
          throw new Error(`Ungültige ID (0–${CFG.MAX_INDEX})`);
        }

        const donation = getSelectedDonation();
        const donationLamports = Math.round(donation * 1e9);

        // Balance mit RPC-Fallback
        let bal;
        try {
          bal = await umi.rpc.getBalance(umi.identity.publicKey);
        } catch (e) {
          if (e.message.includes("429")) {
            log("RPC Rate Limit erreicht, wechsle RPC");
            setRpc(CFG.currentRPC + 1);
            bal = await umi.rpc.getBalance(umi.identity.publicKey);
          } else {
            throw e;
          }
        }
        
        const sol = Number(bal.basisPoints) / 1e9;
        const need = CFG.BASE_ESTIMATED_COST + donation;
        
        if (sol < need) {
          throw new Error(`Unzureichendes SOL (~${need.toFixed(3)} SOL benötigt)`);
        }

        setStatus("Baue Transaktion...", "info");
        log("Starte Mint", { 
          id, 
          donation: `${donation} SOL`,
          balance: `${sol} SOL`,
          estimated_cost: `${need} SOL`
        });

        const mint = generateSigner(umi);
        const nftName = `Pi Pyramid #${id}`;
        const nftUri = uriForId(id);

        const collectionMint = umiPk(CFG.COLLECTION_MINT);
        const tokenAccount = findAssociatedTokenPda(umi, { 
          mint: mint.publicKey, 
          owner: umi.identity.publicKey 
        });

        let builder = transactionBuilder()
          .add(setComputeUnitLimit(umi, { units: 400_000 }))
          .add(setComputeUnitPrice(umi, { microLamports: 15_000 })); // Höhere Priority Fee

        // Spende hinzufügen
        if (donationLamports > 0) {
          builder = builder.add(transferSol(umi, {
            from: umi.identity,
            to: umiPk(CFG.CREATOR),
            amount: lamports(donationLamports)
          }));
          log("Spende hinzugefügt", { amount: `${donation} SOL` });
        }

        // NFT Erstellung
        builder = builder.add(createV1(umi, {
          mint,
          name: nftName,
          uri: nftUri,
          sellerFeeBasisPoints: CFG.ROYALTY_BPS,
          creators: some([{ 
            address: umiPk(CFG.CREATOR), 
            verified: true, 
            share: 100 
          }]),
          collection: some({ 
            key: collectionMint, 
            verified: false 
          }),
          tokenStandard: CFG.TOKEN_STANDARD,
          isMutable: true,
        }));

        // Mint Prozess
        builder = builder.add(mintV1(umi, {
          mint: mint.publicKey,
          authority: umi.identity,
          token: tokenAccount,
          amount: 1,
          tokenOwner: umi.identity.publicKey,
          tokenStandard: CFG.TOKEN_STANDARD,
        }));

        setStatus("Bitte im Wallet signieren…", "");
        log("Sende Transaktion…", {
          instructions: builder.items.length,
          rpc: CFG.RPCs[CFG.currentRPC]
        });

        // Transaktion senden
        const result = await builder.sendAndConfirm(umi, {
          confirm: { commitment: 'confirmed' }
        });

        const txSig = base58.encode(result.signature);
        const link = `https://solscan.io/tx/${txSig}?cluster=mainnet`;
        
        setStatus(`✅ Mint erfolgreich! <a href="${link}" target="_blank" rel="noopener">Transaktion ansehen</a>`, "ok");
        log("Mint erfolgreich", { 
          signature: txSig,
          explorer: link,
          nft_id: id
        });

        claimedSet.add(id); 
        recomputeAvailable(); 
        await setRandomFreeId();
        await updateBalance();

      } catch (e) {
        handleError("Mint fehlgeschlagen:", e);
      } finally {
        setSpin(false);
        mintBtn.disabled = false;
        const btnLabel = mintBtn.querySelector(".btn-label");
        if (btnLabel) btnLabel.textContent = originalText;
      }
    }

    /* ========= ERRORS ========= */
    function handleError(context, e) {
      console.error(context, e);
      let msg = e?.message || String(e);
      let userMsg = msg;
      
      if (/user rejected|reject/i.test(msg)) userMsg = "Signierung abgebrochen";
      else if (/insufficient funds/i.test(msg)) userMsg = "Unzureichendes SOL-Guthaben";
      else if (/already in use/i.test(msg)) userMsg = "ID bereits gemintet";
      else if (/429|rate limit/i.test(msg)) userMsg = "RPC überlastet - bitte erneut versuchen";
      else if (/invalid public key/i.test(msg)) userMsg = "Ungültige Wallet-Adresse";
      
      setStatus(`❌ ${userMsg}`, "err");
      log(`${context} ${msg}`, { error: e });
    }

    /* ========= SPENDE ========= */
    function getSelectedDonation() {
      const sel = document.querySelector('#donationOptions input[name="donation"]:checked');
      if (!sel) return 0;
      if (sel.value === "custom") {
        const v = parseFloat($("customDonationInput").value);
        return isNaN(v) ? 0 : Math.max(0, v);
      }
      return parseFloat(sel.value);
    }
    
    function updateEstimatedCost() {
      const total = CFG.BASE_ESTIMATED_COST + getSelectedDonation();
      $("costLabel").textContent = `≈ ${total.toFixed(3)} SOL`;
    }

    /* ========= BALANCE ========= */
    async function updateBalance() {
      if (!umi) return;
      try {
        const bal = await umi.rpc.getBalance(umi.identity.publicKey);
        const sol = Number(bal.basisPoints) / 1e9;
        $("balanceLabel").textContent = `${sol.toFixed(4)} SOL`;

        const total = CFG.BASE_ESTIMATED_COST + getSelectedDonation();
        if (sol < total * 1.2) {
          $("balanceLabel").classList.add("low-balance");
          setStatus(`⚠️ Niedriges Guthaben (${sol.toFixed(4)} SOL)`, "warn");
        } else {
          $("balanceLabel").classList.remove("low-balance");
        }
      } catch (e) {
        log("Balance-Abfrage fehlgeschlagen:", e);
        if (e.message.includes("429")) {
          log("RPC Rate Limit, wechsle RPC");
          setRpc(CFG.currentRPC + 1);
          await updateBalance();
        }
      }
    }

    /* ========= UI INIT ========= */
    function wireUI() {
      // Phantom Verbindung
      $("connectBtn")?.addEventListener("click", connectPhantom);
      
      // Haupt-Buttons
      $("mintBtn")?.addEventListener("click", doMint);
      $("randBtn")?.addEventListener("click", setRandomFreeId);
      $("tokenId")?.addEventListener("input", updatePreview);
      
      // Logs
      $("toggleLogs")?.addEventListener("click", () => {
        const el = $("log");
        el.classList.toggle("hidden");
        $("toggleLogs").textContent = el.classList.contains("hidden") ? "Anzeigen" : "Ausblenden";
      });

      // Spenden-UI
      const pills = Array.from(document.querySelectorAll('#donationOptions .pill'));
      const customContainer = $("customDonationContainer");
      const customInput = $("customDonationInput");
      
      const applyDonationSelection = () => {
        pills.forEach(p => p.classList.remove("active"));
        const checked = document.querySelector('#donationOptions input[name="donation"]:checked');
        if (!checked) return;
        
        const pill = checked.closest(".pill");
        if (pill) pill.classList.add("active");
        
        if (checked.value === "custom") {
          customContainer.classList.add("visible");
          customInput.focus();
        } else {
          customContainer.classList.remove("visible");
        }
        
        updateEstimatedCost();
      };

      pills.forEach(pill => {
        pill.addEventListener("click", () => {
          const radio = pill.querySelector('input[name="donation"]');
          if (!radio) return;
          radio.checked = true;
          applyDonationSelection();
        });
      });

      document.querySelectorAll('#donationOptions input[name="donation"]').forEach(radio => {
        radio.addEventListener("change", applyDonationSelection);
      });

      customInput?.addEventListener("input", updateEstimatedCost);
    }

    /* ========= START ========= */
    document.addEventListener("DOMContentLoaded", async () => {
      // Prüfe auf HTTPS
      if (location.protocol !== 'https:') {
        $("fatal").style.display = "block";
        $("fatal").textContent = "❌ Diese Seite muss über HTTPS geladen werden, um Wallets zu verwenden.";
        return;
      }
      
      wireUI();
      recomputeAvailable();
      await setRandomFreeId();
      log("System initialisiert", { 
        rpc: CFG.RPCs[CFG.currentRPC],
        creator: CFG.CREATOR,
        max_index: CFG.MAX_INDEX
      });
    });
  </script>
</body>
</html>